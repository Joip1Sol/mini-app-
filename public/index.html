<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinFlip Duelo - Imprenta</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* ... (mantener todos los estilos existentes) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- ... (mantener toda la estructura HTML existente) ... -->
    </div>

    <script>
        // Estado del juego
        let gameState = {
            playerA: null,
            playerB: null,
            betAmount: 0,
            status: 'waiting',
            winner: null,
            countdown: 10,
            history: [],
            currentDuelId: null,
            connection: {
                connected: true,
                lastUpdate: null
            },
            serverTimeOffset: 0
        };

        // Inicializar Socket.IO
        const socket = io();

        // Inicializar la aplicaci√≥n
        function initApp() {
            initWebSocket();
            updateUI();
            
            // Sincronizar hora con el servidor
            syncServerTime();
        }

        // Sincronizar hora con el servidor
        function syncServerTime() {
            const start = Date.now();
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    const end = Date.now();
                    const rtt = end - start;
                    gameState.serverTimeOffset = data.timestamp - (start + rtt/2);
                    console.log('‚è∞ Hora sincronizada con servidor');
                })
                .catch(error => {
                    console.error('Error sincronizando hora:', error);
                });
        }

        function initWebSocket() {
            socket.on('duel-update', (duel) => {
                console.log('üì® Recibiendo actualizaci√≥n del backend...', duel);
                
                if (duel) {
                    gameState.playerA = duel.playerA;
                    gameState.playerB = duel.playerB;
                    gameState.betAmount = duel.betAmount;
                    gameState.status = duel.status;
                    gameState.winner = duel.winner;
                    gameState.currentDuelId = duel._id;
                    
                    if (duel.status === 'countdown') {
                        // El servidor manejar√° el countdown
                        document.getElementById('countdown').classList.remove('hidden');
                    } else if (duel.status === 'completed') {
                        // El servidor enviar√° el resultado
                    }
                } else {
                    resetDuel();
                }
                
                updateUI();
            });

            // Escuchar actualizaciones del countdown desde el servidor
            socket.on('countdown-update', (data) => {
                if (data.duelId === gameState.currentDuelId) {
                    gameState.countdown = data.countdown;
                    updateUI();
                    
                    if (data.countdown <= 0) {
                        // Iniciar animaci√≥n de moneda
                        startDuelAnimation();
                    }
                }
            });

            // Escuchar resultados del servidor
            socket.on('duel-result', (resultData) => {
                if (resultData.duelId === gameState.currentDuelId) {
                    gameState.winner = resultData.winner;
                    gameState.status = 'completed';
                    
                    // Actualizar moneda para que coincida con el resultado
                    updateCoinResult(resultData.winner.telegramId === gameState.playerA.telegramId ? 'A' : 'B');
                    
                    // A√±adir al historial
                    addToHistory(resultData.winner, resultData.loser, resultData.resultText === 'heads' ? 'Cara' : 'Cruz');
                    
                    updateUI();
                    
                    // Reiniciar despu√©s de 5 segundos
                    setTimeout(() => {
                        resetDuel();
                    }, 5000);
                }
            });

            socket.on('connect', () => {
                updateConnectionStatus(true);
                
                // Solicitar estado actual al reconectar
                if (gameState.currentDuelId) {
                    socket.emit('request-duel-result', gameState.currentDuelId);
                }
            });

            socket.on('disconnect', () => {
                updateConnectionStatus(false);
            });
        }

        // Actualizar estado de conexi√≥n
        function updateConnectionStatus(connected) {
            const connectionStatus = document.getElementById('connection-status');
            gameState.connection.connected = connected;
            gameState.connection.lastUpdate = new Date();
            
            if (connected) {
                connectionStatus.className = 'connection-status connected';
                connectionStatus.innerHTML = '‚óè Conectado';
            } else {
                connectionStatus.className = 'connection-status disconnected';
                connectionStatus.innerHTML = '‚óè Reconectando...';
            }
        }

        // Iniciar animaci√≥n de la moneda (sincronizada)
        function startDuelAnimation() {
            gameState.status = 'in-progress';
            updateUI();
            
            // Ocultar countdown
            document.getElementById('countdown').classList.add('hidden');
            
            // Animaci√≥n de la moneda
            document.getElementById('coin').classList.add('flipping');
        }

        // Reiniciar duelo
        function resetDuel() {
            gameState.playerA = null;
            gameState.playerB = null;
            gameState.status = 'waiting';
            gameState.winner = null;
            gameState.countdown = 10;
            gameState.betAmount = 0;
            gameState.currentDuelId = null;
            
            // Resetear moneda
            document.getElementById('front-text').textContent = 'A';
            document.getElementById('back-text').textContent = 'B';
            document.getElementById('front-text').parentElement.classList.remove('winner-side');
            document.getElementById('back-text').parentElement.classList.remove('winner-side');
            document.getElementById('coin').classList.remove('flipping');
            
            updateUI();
        }

        // Funci√≥n para actualizar la moneda seg√∫n el resultado
        function updateCoinResult(winnerSide) {
            const frontText = document.getElementById('front-text');
            const backText = document.getElementById('back-text');
            
            // Resetear clases
            document.getElementById('front-text').parentElement.classList.remove('winner-side');
            document.getElementById('back-text').parentElement.classList.remove('winner-side');
            
            if (winnerSide === 'A') {
                frontText.textContent = 'A';
                backText.textContent = 'B';
                document.getElementById('front-text').parentElement.classList.add('winner-side');
            } else {
                frontText.textContent = 'B';
                backText.textContent = 'A';
                document.getElementById('back-text').parentElement.classList.add('winner-side');
            }
        }

        // A√±adir partida al historial
        function addToHistory(winner, loser, result) {
            const historyItems = document.getElementById('history-items');
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            // Usar first_name, username o "Jugador" como fallback
            const winnerName = winner.first_name || winner.username || 'Ganador';
            const loserName = loser.first_name || loser.username || 'Perdedor';
            
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <span>${winnerName} vs ${loserName}</span>
                <span>${timeString} (${result})</span>
            `;
            
            if (historyItems.children.length === 1 && 
                historyItems.children[0].textContent.includes('Esperando')) {
                historyItems.innerHTML = '';
            }
            
            historyItems.prepend(historyItem);
            
            gameState.history.unshift({
                winner: winnerName,
                loser: loserName,
                result: result,
                time: timeString
            });
        }

        // Funci√≥n para limpiar manualmente
        function clearDuel() {
            fetch('/api/clear-duel', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log('Duelo limpiado:', data);
                    resetDuel();
                })
                .catch(error => {
                    console.error('Error limpiando duelo:', error);
                });
        }

        // Actualizar la interfaz de usuario
        function updateUI() {
            // Actualizar jugadores
            document.getElementById('player-a-name').textContent = 
                gameState.playerA ? (gameState.playerA.first_name || 'Jugador A') : 'Esperando...';
            document.getElementById('player-b-name').textContent = 
                gameState.playerB ? (gameState.playerB.first_name || 'Jugador B') : 'Disponible';
                
            // Actualizar usernames de jugadores
            document.getElementById('player-a-username').textContent = 
                gameState.playerA && gameState.playerA.username ? `@${gameState.playerA.username}` : '';
            document.getElementById('player-b-username').textContent = 
                gameState.playerB && gameState.playerB.username ? `@${gameState.playerB.username}` : '';
                
            // Actualizar IDs de jugadores
            document.getElementById('player-a-id').textContent = 
                gameState.playerA ? `ID: ${gameState.playerA.telegramId}` : 'ID: --';
            document.getElementById('player-b-id').textContent = 
                gameState.playerB ? `ID: ${gameState.playerB.telegramId}` : 'ID: --';
            
            // Actualizar apuesta
            document.getElementById('bet-amount').textContent = gameState.betAmount;
            
            // Actualizar estado de los jugadores
            document.getElementById('player-a').classList.toggle('active', gameState.playerA !== null);
            document.getElementById('player-b').classList.toggle('active', gameState.playerB !== null);
            
            // Actualizar banner de estado
            const statusBanner = document.getElementById('status-banner');
            const statusText = document.getElementById('status-text');
            
            if (gameState.status === 'waiting') {
                statusBanner.className = 'status-banner status-waiting';
                statusText.textContent = gameState.playerA ? 
                    '‚è≥ Esperando que alguien se una al duelo' : 
                    '‚úÖ Esperando comando /pvp desde Telegram';
            } else if (gameState.status === 'countdown') {
                statusBanner.className = 'status-banner status-countdown';
                statusText.textContent = `‚è∞ Duelo comenzando en ${gameState.countdown}s...`;
            } else if (gameState.status === 'in-progress') {
                statusBanner.className = 'status-banner status-countdown';
                statusText.textContent = 'üéØ Moneda girando...';
            } else if (gameState.status === 'completed') {
                statusBanner.className = 'status-banner status-completed';
                statusText.textContent = '‚úÖ Duelo completado';
            }
            
            // Mostrar resultado si el duelo est√° completado
            const resultSection = document.getElementById('result-section');
            if (gameState.status === 'completed' && gameState.winner) {
                resultSection.classList.remove('hidden');
                
                const loser = gameState.winner.telegramId === gameState.playerA.telegramId ? gameState.playerB : gameState.playerA;
                const winnerName = gameState.winner.first_name || gameState.winner.username || 'Ganador';
                const loserName = loser.first_name || loser.username || 'Perdedor';
                const winnerUsername = gameState.winner.username ? ` (@${gameState.winner.username})` : '';
                const loserUsername = loser.username ? ` (@${loser.username})` : '';
                
                document.getElementById('winner-text').textContent = `üéâ ¬°${winnerName} gana!`;
                document.getElementById('result-details').innerHTML = `
                    <div>üëë <strong>Ganador:</strong> ${winnerName}${winnerUsername}</div>
                    <div>üíî <strong>Perdedor:</strong> ${loserName}${loserUsername}</div>
                    <div>üí∞ <strong>Premio:</strong> ${gameState.betAmount * 2} puntos</div>
                    <div>üéØ <strong>Resultado:</strong> ${gameState.winner.telegramId === gameState.playerA.telegramId ? 'üü° Cara' : '‚ö´ Cruz'}</div>
                `;
                
                // Marcar jugador ganador
                document.getElementById('player-a').classList.remove('winner');
                document.getElementById('player-b').classList.remove('winner');
                document.getElementById(gameState.winner.telegramId === gameState.playerA.telegramId ? 'player-a' : 'player-b')
                    .classList.add('winner');
            } else {
                resultSection.classList.add('hidden');
                
                // Quitar marca de ganador
                document.getElementById('player-a').classList.remove('winner');
                document.getElementById('player-b').classList.remove('winner');
            }
            
            // Actualizar countdown
            document.getElementById('countdown-value').textContent = gameState.countdown;
        }

        // Inicializar la aplicaci√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>